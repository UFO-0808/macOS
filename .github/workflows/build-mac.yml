name: Build Universal macOS App

on:
  push:
    tags:
      - 'v*'           # 只有推送类似 v1.0 的标签时才触发，节省资源
  workflow_dispatch:    # 允许在 GitHub 网页手动触发构建

jobs:
  build:
    runs-on: macos-latest  # 使用最新的 macOS Runner（内含 M1 环境）
    strategy:
      matrix:
        python-version: ['3.9']  # 使用稳定的 Python 3.9

    steps:
    - name: 检出代码
      uses: actions/checkout@v4  # 升级到 v4

    - name: 设置 Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5  # 升级到 v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        # 如果存在 requirements.txt，优先使用它
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          # 否则安装核心依赖
          pip install PyInstaller PySide6 aiohttp
        fi

    - name: 为双架构分别打包
      run: |
        # 1. 打包 x86_64 版本（在 M1 Runner 上通过 Rosetta 2 模拟运行）
        arch -x86_64 python -m PyInstaller \
          --onefile \
          --windowed \
          --name "CloudflareScan_x86_64" \
          --hidden-import=asyncio \
          --hidden-import=aiohttp \
          --hidden-import=PySide6.QtCore \
          --hidden-import=PySide6.QtGui \
          --hidden-import=PySide6.QtWidgets \
          --add-data "./:." \
          ./cfs-mac.py

        # 2. 打包原生 arm64 版本
        python -m PyInstaller \
          --onefile \
          --windowed \
          --name "CloudflareScan_arm64" \
          --hidden-import=asyncio \
          --hidden-import=aiohttp \
          --hidden-import=PySide6.QtCore \
          --hidden-import=PySide6.QtGui \
          --hidden-import=PySide6.QtWidgets \
          --add-data "./:." \
          ./cfs-mac.py

    - name: 合并为通用二进制
      run: |
        # 使用 lipo 工具合并两个架构的可执行文件
        lipo -create -output "CloudflareScan_Universal" \
          "./dist/CloudflareScan_x86_64" \
          "./dist/CloudflareScan_arm64"
        chmod +x "CloudflareScan_Universal"
        # 输出验证信息
        echo "✅ 通用二进制文件创建成功，架构信息如下："
        lipo -info "CloudflareScan_Universal"

    - name: 准备发布文件
      run: |
        mkdir -p release
        mv "CloudflareScan_Universal" release/
        # 可选：复制图标文件
        if [ -f cfs.icns ]; then
          cp cfs.icns release/
        fi
        echo "# Cloudflare Scan (Universal macOS App)" > release/README.txt
        echo "构建时间: $(date)" >> release/README.txt

    - name: 创建 Release 压缩包
      run: |
        cd release
        zip -r "../CloudflareScan_macOS_Universal.zip" .

    - name: 上传构建产物 (Artifact)
      uses: actions/upload-artifact@v4  # 关键修复：升级到 v4
      with:
        name: CloudflareScan-Universal
        path: CloudflareScan_macOS_Universal.zip
        retention-days: 7  # 产物保留天数（免费额度内）
