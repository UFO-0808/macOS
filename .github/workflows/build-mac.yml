name: Build macOS Application

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    strategy:
      matrix:
        python-version: ["3.10"]
        include:
          - target: x86_64
            suffix: x86_64
            arch_flag: "--target-architecture x86_64"
          - target: arm64
            suffix: arm64
            arch_flag: "--target-architecture arm64"
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller==5.13.0
    
    - name: Build application
      run: |
        BUILD_NAME="CloudflareScan_${{ matrix.suffix }}"
        
        echo "构建架构: ${{ matrix.target }}"
        echo "构建参数: ${{ matrix.arch_flag }}"
        
        # 使用PyInstaller构建
        python -m PyInstaller --onefile --windowed \
          --name $BUILD_NAME \
          --icon=cfs.icns \
          --add-data "cfs.icns:." \
          ${{ matrix.arch_flag }} \
          cfs-mac.py
        
        echo "=== 验证构建文件 ==="
        if [ -d "dist/$BUILD_NAME.app" ]; then
          echo "✓ 应用包创建成功"
          # 检查二进制文件的架构
          if [ -f "dist/$BUILD_NAME.app/Contents/MacOS/$BUILD_NAME" ]; then
            file "dist/$BUILD_NAME.app/Contents/MacOS/$BUILD_NAME"
            lipo -archs "dist/$BUILD_NAME.app/Contents/MacOS/$BUILD_NAME" 2>/dev/null || echo "无法获取架构信息"
          fi
        else
          echo "✗ 应用包创建失败"
          ls -la dist/
        fi
    
    - name: Create DMG
      if: success()
      run: |
        BUILD_NAME="CloudflareScan_${{ matrix.suffix }}"
        DMG_NAME="CloudflareScan_${{ matrix.suffix }}.dmg"
        
        brew install create-dmg
        
        create-dmg \
          --volname "CloudflareScan" \
          --volicon "cfs.icns" \
          --window-pos 200 120 \
          --window-size 800 400 \
          --icon-size 100 \
          --icon "$BUILD_NAME.app" 200 190 \
          --hide-extension "$BUILD_NAME.app" \
          --app-drop-link 600 185 \
          "$DMG_NAME" \
          "dist/"
        
        echo "DMG文件大小:"
        du -h "$DMG_NAME"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CloudflareScan-${{ matrix.suffix }}
        path: |
          dist/CloudflareScan_${{ matrix.suffix }}.app
          CloudflareScan_${{ matrix.suffix }}.dmg
        retention-days: 7
